---
import Layout from '../layouts/Layout.astro';
import '../styles/estilos.css';
import Footer from '../components/footer.astro';
import { supabase } from '../lib/supabase.ts';
---

<Layout title="Crear Usuario">

<main style="padding-top: 70px;"></main>
<main class="new_user">

  <div class="container d-flex justify-content-center align-items-center min-vh-100">
    <div class="form-container p-4 shadow-lg">
      <h2 class="text-center mb-4">Crear Usuario</h2>

      <div id="message" class="mb-3 text-center" style="color: red;"></div>

      <form id="registerForm">
        <div class="mb-3">
          <label for="name" class="form-label">Nombre Completo</label>
          <input type="text" class="form-control" id="name" required />
        </div>
        <div class="mb-3">
          <label for="email" class="form-label">Correo Electrónico</label>
          <input type="email" class="form-control" id="email" required />
        </div>
        <div class="mb-3">
          <label for="password" class="form-label">Contraseña</label>
          <input type="password" class="form-control" id="password" required />
        </div>
        <div class="mb-3">
          <label for="passwordConfirm" class="form-label">Confirmar Contraseña</label>
          <input type="password" class="form-control" id="passwordConfirm" required />
        </div>
        <button type="submit" class="btn btn-gradient w-100">Crear Usuario</button>
      </form>

      <p class="mt-3 text-center">
        ¿Ya tienes cuenta? <a href="/ini_sesion">Iniciar Sesión</a>
      </p>
    </div>
  </div>

</main>

<script type="module">
  import { supabase } from '../lib/supabase.ts';

  const registerForm = document.getElementById('registerForm');
  const messageDiv = document.getElementById('message');

  registerForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const name = document.getElementById('name').value;
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const passwordConfirm = document.getElementById('passwordConfirm').value;

    if (password !== passwordConfirm) {
      messageDiv.textContent = '❌ Las contraseñas no coinciden';
      return;
    }

    const { data, error } = await supabase.auth.signUp({
      email,
      password,
      options: {
        data: { full_name: name }
      }
    });

    if (error) {
      messageDiv.textContent = error.message;
    } else {
      messageDiv.style.color = 'green';
      messageDiv.textContent = '✔ Usuario creado. Revisa tu correo.';

      setTimeout(() => {
        window.location.href = '/ini_sesion';
      }, 2500);
    }
  });
</script>

<Footer />
</Layout>

<style>
  @import '../styles/new_user.css';
</style>
