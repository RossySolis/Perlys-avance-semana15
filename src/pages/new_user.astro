---
import Layout from '../layouts/Layout.astro';
import '../styles/estilos.css';
import Footer from '../components/footer.astro';
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = import.meta.env.SUPABASE_URL;
const supabaseAnonKey = import.meta.env.SUPABASE_ANON_KEY;
const supabase = createClient(supabaseUrl, supabaseAnonKey);
---

<Layout title="Crear Usuario">
    
<main style="padding-top: 70px;"></main>
<main class="new_user">

  <div class="container d-flex justify-content-center align-items-center min-vh-100">
    <div class="form-container p-4 shadow-lg">
      <h2 class="text-center mb-4">Crear Usuario</h2>

      <!-- Mensajes de error o éxito -->
      <div id="message" class="mb-3 text-center" style="color: red;"></div>

      <form id="registerForm">
        <div class="mb-3">
          <label for="name" class="form-label">Nombre Completo</label>
          <input type="text" class="form-control" id="name" name="name" placeholder="Tu nombre completo" required />
        </div>
        <div class="mb-3">
          <label for="email" class="form-label">Correo Electrónico</label>
          <input type="email" class="form-control" id="email" name="email" placeholder="usuario@ejemplo.com" required />
        </div>
        <div class="mb-3">
          <label for="password" class="form-label">Contraseña</label>
          <input type="password" class="form-control" id="password" name="password" placeholder="Contraseña" required />
        </div>
        <div class="mb-3">
          <label for="passwordConfirm" class="form-label">Confirmar Contraseña</label>
          <input type="password" class="form-control" id="passwordConfirm" name="passwordConfirm" placeholder="Repite la contraseña" required />
        </div>
        <button type="submit" class="btn btn-gradient w-100">Crear Usuario</button>
      </form>

      <p class="mt-3 text-center">
        ¿Ya tienes cuenta? <a href="/signin">Iniciar Sesión</a>
      </p>
    </div>
  </div>
  
  <!-- Botones flotantes -->
  <div class="social-float">
    <a href="https://www.facebook.com/p/Perlys-Moda-100064165537001/?locale=uk_UA" target="_blank" class="facebook">
      <i class="fa-brands fa-facebook"></i>
    </a>
    <a href="https://instagram.com" target="_blank" class="instagram">
      <i class="fa-brands fa-instagram"></i>
    </a>
    <a href="https://wa.me/51940042294" target="_blank" class="whatsapp">
      <i class="fa-brands fa-whatsapp"></i>
    </a>
    <a href="https://www.tiktok.com/@modaperlys?_t=8p60CYtJXOQ&_r=1" target="_blank" class="tiktok">
      <i class="fa-brands fa-tiktok"></i>
    </a>
  </div>

</main>

<script type="module">
  const registerForm = document.getElementById('registerForm');
  const messageDiv = document.getElementById('message');

  registerForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const name = document.getElementById('name').value;
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const passwordConfirm = document.getElementById('passwordConfirm').value;

    // Validar que las contraseñas coincidan
    if (password !== passwordConfirm) {
      messageDiv.style.color = 'red';
      messageDiv.textContent = 'Las contraseñas no coinciden';
      return;
    }

    // Registrar usuario en Supabase
    const { data, error } = await supabase.auth.signUp({
      email,
      password,
    }, {
      data: { full_name: name } // Guardar nombre completo en metadata
    });

    if (error) {
      messageDiv.style.color = 'red';
      messageDiv.textContent = error.message;
    } else {
      messageDiv.style.color = 'green';
      messageDiv.textContent = 'Usuario creado correctamente. Redirigiendo al login...';
      // Limpiar formulario
      registerForm.reset();

      // Redirigir automáticamente al login después de 3 segundos
      setTimeout(() => {
        window.location.href = '/signin';
      }, 3000);
    }
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<Footer />
</Layout>

<style>
  @import '../styles/new_user.css';
</style>
