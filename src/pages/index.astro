---
import Layout from '../layouts/Layout.astro';
import Footer from '../components/footer.astro';
import '../styles/estilos.css';
import { supabase } from '../lib/supabase.ts';

let { data: productos, error } = await supabase
  .from('productos')
  .select('id, nombre, precio, stock, image_url')
  .order('id', { ascending: false });
---

<Layout>

  <!-- Hero principal -->
  <header class="hero relative h-[450px] overflow-hidden" id="inicio">
    <div class="absolute top-0 left-0 w-full h-full overflow-hidden z-0">
      <img src="/img/perlys.jpg" alt="Moda Infantil" class="w-full h-full object-cover filter brightness-85">
    </div>

    <div class="hero-content relative text-center mx-auto max-w-lg z-10 text-pink-700 pt-[140px]">
      <h1 class="text-4xl md:text-5xl font-bold">Perly‚Äôs</h1>
      <h2 class="text-xl md:text-2xl">Moda actualizada para ni√±as</h2>
      <p class="text-base md:text-lg">Todo lo que buscas en un solo lugar</p>
      <a href="#productos" class="inline-block mt-3 bg-pink-600 text-white py-2 px-5 rounded-full hover:bg-pink-700 transition-colors">
        Ver productos
      </a>
    </div>
  </header>

  <!-- Secci√≥n de productos -->
  <section id="productos" class="productos text-center py-10 bg-pink-50">
    <h2 class="text-2xl md:text-3xl font-semibold text-pink-700 mb-8">‚ú® Top Productos de Perly's ‚ú®</h2>

    <div class="container mx-auto px-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-3 gap-6">

      {productos?.map(producto => (
        <div class="card shadow-lg rounded-2xl overflow-hidden h-full">

          {producto.image_url ? (
            <img src={producto.image_url} class="w-full h-64 object-cover" alt={producto.nombre} />
          ) : (
            <div class="w-full h-64 bg-gray-200 flex items-center justify-center">No image</div>
          )}

          <div class="p-4 text-left">
            <h3 class="font-semibold text-lg">{producto.nombre}</h3>
            <p>S/{producto.precio}</p>

            <button 
              class="btn-add-cart mt-2 bg-pink-600 text-white py-1 px-4 rounded-full hover:bg-pink-700 transition-colors"
              data-product={JSON.stringify(producto)}
            >
              Agregar al carrito
            </button>
          </div>

        </div>
      ))}

    </div>
  </section>

  <!-- CARRITO FLOTANTE -->
  <div id="cart" class="fixed top-20 right-5 w-80 bg-white shadow-lg p-4 rounded hidden z-50">
    <h3 class="text-lg font-bold mb-2">Carrito</h3>
    <div id="cart-items" class="space-y-2"></div>
    <div class="mt-4 font-semibold">Total: S/<span id="cart-total">0.00</span></div>

    <button id="close-cart" class="mt-3 w-full bg-red-500 text-white py-1 rounded hover:bg-red-600 transition-colors">
      Cerrar
    </button>
  </div>

  <!-- BOT√ìN FLOTANTE PARA ABRIR -->
  <button id="open-cart" class="fixed bottom-5 right-5 bg-pink-600 text-white p-3 rounded-full shadow-lg hover:bg-pink-700 transition-colors">
    üõí
  </button>

  <!-- Promoci√≥n -->
  <section class="promo text-center py-10 bg-purple-100 text-purple-800">
    <h2 class="text-2xl font-semibold">üå∏ 20% de descuento en tu primer pedido üå∏</h2>
    <p class="mt-2">¬°Aprovecha nuestra promoci√≥n especial y v√≠stelas con ternura y estilo!</p>
    <a href="/pedidos" class="inline-block mt-3 bg-pink-600 text-white py-2 px-5 rounded-full hover:bg-pink-700 transition-colors">
      Pedir ahora
    </a>
  </section>

  <Footer />

  <!-- Toast -->
  <div id="toast" class="fixed bottom-5 right-5 bg-pink-600 text-white px-4 py-2 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 z-50"></div>

</Layout>

<!-- ========== SCRIPT DEL CARRITO 100% FUNCIONAL ========== -->
<script>
  function showToast(msg) {
    const toast = document.getElementById("toast");
    toast.textContent = msg;
    toast.classList.add("opacity-100");
    setTimeout(() => toast.classList.remove("opacity-100"), 2000);
  }

  function getCart() {
    return JSON.parse(localStorage.getItem("cart")) || [];
  }

  function saveCart(cart) {
    localStorage.setItem("cart", JSON.stringify(cart));
    renderCart();
  }

  // VALIDAR STOCK EN SUPABASE
  async function validarStock(productId, cantidadDeseada) {
    const resp = await fetch("/api/stock?id=" + productId);
    const data = await resp.json();
    return cantidadDeseada <= data.stock;
  }

  async function addToCart(producto) {
    let cart = getCart();
    const existing = cart.find(item => item.id === producto.id);
    const qtyFinal = existing ? existing.quantity + 1 : 1;

    const stockOK = await validarStock(producto.id, qtyFinal);
    if (!stockOK) {
      alert("‚ùå Stock insuficiente");
      return;
    }

    if (existing) {
      existing.quantity += 1;
    } else {
      cart.push({
        id: producto.id,
        name: producto.nombre,
        price: producto.precio,
        image: producto.image_url,
        quantity: 1
      });
    }

    saveCart(cart);
    renderCart(); // actualizar carrito inmediatamente
    showToast(`‚úÖ ${producto.nombre} agregado al carrito`);
    document.getElementById("cart").classList.remove("hidden"); // abrir carrito autom√°ticamente
  }

  // RENDER CARRITO
  function renderCart() {
    let cart = getCart();
    const cartDiv = document.getElementById("cart-items");
    const totalSpan = document.getElementById("cart-total");

    if (cart.length === 0) {
      cartDiv.innerHTML = "<p class='text-center'>Carrito vac√≠o</p>";
      totalSpan.textContent = "0.00";
      return;
    }

    cartDiv.innerHTML = cart.map(item => `
      <div class="border p-2 rounded flex justify-between items-center">
        <img src="${item.image}" class="w-12 h-12 rounded object-cover"/>
        <div class="flex-1 px-3">
          <h4>${item.name}</h4>
          <p>S/${item.price}</p>
        </div>
        <div class="flex items-center gap-2">
          <button class="dec bg-gray-300 px-2 rounded" data-id="${item.id}">-</button>
          <span>${item.quantity}</span>
          <button class="inc bg-gray-300 px-2 rounded" data-id="${item.id}">+</button>
        </div>
        <button class="del text-red-500" data-id="${item.id}">üóë</button>
      </div>
    `).join("");

    // Total
    const total = cart.reduce((t, i) => t + i.price * i.quantity, 0);
    totalSpan.textContent = total.toFixed(2);

    // Eventos din√°micos
    document.querySelectorAll(".inc").forEach(btn => {
      btn.addEventListener("click", async () => {
        let cart = getCart();
        const item = cart.find(i => i.id == btn.dataset.id);
        const ok = await validarStock(item.id, item.quantity + 1);
        if (!ok) return alert("‚ùå Stock insuficiente");
        item.quantity++;
        saveCart(cart);
      });
    });

    document.querySelectorAll(".dec").forEach(btn => {
      btn.addEventListener("click", () => {
        let cart = getCart();
        const item = cart.find(i => i.id == btn.dataset.id);
        item.quantity--;
        if (item.quantity <= 0) cart = cart.filter(i => i.id !== item.id);
        saveCart(cart);
      });
    });

    document.querySelectorAll(".del").forEach(btn => {
      btn.addEventListener("click", () => {
        let cart = getCart().filter(i => i.id != btn.dataset.id);
        saveCart(cart);
      });
    });
  }

  // Eventos iniciales
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".btn-add-cart").forEach(btn => {
      btn.addEventListener("click", () => {
        const producto = JSON.parse(btn.dataset.product);
        addToCart(producto);
      });
    });

    document.getElementById("open-cart").onclick = () => {
      document.getElementById("cart").classList.remove("hidden");
      renderCart();
    };

    document.getElementById("close-cart").onclick = () => {
      document.getElementById("cart").classList.add("hidden");
    };
  });
</script>
